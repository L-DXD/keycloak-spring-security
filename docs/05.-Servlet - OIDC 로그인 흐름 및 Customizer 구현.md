# 05. 인증 아키텍처 비교: (1) 순수 세션 방식 vs (2) 하이브리드 방식

## 🎯 목표

API 인증과 **백채널 로그아웃** 기능을 모두 지원하기 위한 두 가지 아키텍처, "순수 세션(Stateful) 방식"과 "하이브리드(Stateless + Session) 방식"을 비교하여 최종 설계 방향을 결정합니다.

---

## 모델 1: 순수 세션(Stateful) 방식

`oauth2Login`을 중심으로 구현하며, 모든 인증이 서버 측 세션에 의존하는 전통적인 방식입니다.

### 📋 인증 흐름

1.  **최초 로그인:** 사용자는 웹 브라우저를 통해 `oauth2Login`으로 최초 로그인합니다.
2.  **세션 생성:** 서버는 토큰을 발급받아 **HTTP 세션을 생성**하고, 이 세션에 사용자 인증 정보(`Authentication` 객체)를 저장합니다.
3.  **이후 모든 요청:** 브라우저가 보내는 **세션 쿠키**를 통해 인증됩니다. 이 방식에서는 `Authorization: Bearer` 헤더를 사용하지 않습니다.
4.  **(커스텀 필터):** 저희가 구현한 `OidcSessionValidationFilter`가 모든 요청 시 세션 내 토큰의 유효성을 검사하고, 만료 시 자동으로 갱신합니다.

### 🔐 백채널 로그아웃

*   **완벽 지원:** Keycloak이 로그아웃 요청을 보내면, 서버는 이 필터가 관리하는 **명확한 사용자 세션을 찾아 파기**할 수 있습니다. Spring Security의 표준 `oauth2Login`이 이 흐름을 지원합니다.

### ✅ 장점과 단점

*   **장점:**
    *   구현이 비교적 단순하고, Spring Security 표준 기능(OIDC 백채널 로그아웃 등)을 최대한 활용합니다.
    *   클라이언트(브라우저)는 토큰 관리에 전혀 신경 쓸 필요가 없어 구현이 간단합니다.
*   **단점:**
    *   모든 요청이 세션에 의존하므로, 서버의 메모리 사용량이 많고 수평 확장에 제약이 따릅니다.
    *   쿠키 기반 세션을 사용하기 어려운 클라이언트(예: 모바일 앱, 외부 시스템)가 API를 호출하는 데 적합하지 않습니다.

---

## 모델 2: 하이브리드 (Stateless 인증 + 세션) 방식

API 인증은 Stateless(토큰 기반)로 처리하면서, 백채널 로그아웃을 위해 세션을 보조적으로 사용하는 복합적인 방식입니다.

### 📋 인증 흐름

1.  **API 요청 (Stateless):**
    *   클라이언트는 `Authorization: Bearer <Access Token>` 헤더를 포함하여 API를 요청합니다.
    *   서버는 `oauth2ResourceServer` 설정을 통해 이 토큰을 검증하고, **세션을 조회하지 않고** 요청을 처리합니다. (`KeycloakJwtAuthenticationConverter`가 여기서 사용됩니다.)
2.  **세션 생성 및 관리 (로그아웃 목적):**
    *   **문제점:** 언제, 어떻게 세션을 생성하고 관리할지 명확한 전략을 직접 구현해야 합니다.
    *   **구현 예시:** 사용자가 최초 로그인하는 특정 엔드포인트(`/login`)를 만듭니다. 이 엔드포인트는 토큰을 검증한 후, 해당 사용자의 OIDC 세션 ID(`sid`)와 우리 서버의 `HttpSession` ID를 **별도의 저장소(예: Redis)**에 매핑하여 저장합니다.

### 🔐 백채널 로그아웃

*   **조건부 지원 (복잡):** Keycloak이 로그아웃 요청을 보내면, 서버는 미리 저장해 둔 **`sid`-`HttpSession` 매핑 정보**를 조회하여 해당하는 세션을 찾아 파기합니다. 이 매핑 정보를 저장하고 관리하는 별도의 로직 구현이 필수적입니다.

### ✅ 장점과 단점

*   **장점:**
    *   API의 확장성(Stateless)과 백채널 로그아웃 기능을 이론상 둘 다 가져갈 수 있습니다.
    *   다양한 종류의 클라이언트(웹, 모바일 등)를 모두 지원하기에 용이합니다.
*   **단점:**
    *   **구현이 매우 복잡합니다.** Spring Security가 기본으로 제공하는 기능이 아니므로, 세션 생성 시점, `sid`-세션 ID 매핑/저장/조회/삭제 로직을 모두 직접 개발해야 합니다.
    *   `oauth2Login`과 `oauth2ResourceServer`를 한 애플리케이션에서 동시에, 그리고 매끄럽게 연동시키는 것은 고도의 설정 기술을 요구하여 유지보수가 어렵습니다.

---

### 💡 결론 및 제안

*   **"순수 세션 방식"**은 구현이 명확하고 Spring Security 표준에 가까우며, **백채널 로그아웃**이라는 요구사항을 가장 확실하게 만족시킵니다.
*   **"하이브리드 방식"**은 기술적으로 가능하지만, 복잡도가 매우 높고 직접 구현해야 할 부분이 많아 개발 및 유지보수 비용이 크게 증가합니다.

**제안:** 현재 라이브러리의 1차 목표가 **"백채널 로그아웃을 지원하는 웹 애플리케이션 보안"**이라면, **`모델 1: 순수 세션(Stateful) 방식`**으로 구현을 완료하고, 추후 필요시 Stateless API 지원을 별도의 모듈이나 설정으로 추가하는 것이 안정적이고 현실적인 접근 방식입니다.

이 비교 내용을 바탕으로 어떤 방향으로 진행할지 결정해주시면 감사하겠습니다.