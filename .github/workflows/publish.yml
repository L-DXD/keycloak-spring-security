name: Publish to Maven Central

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'

  # 수동 실행 지원 (테스트/긴급 배포용)
  workflow_dispatch:

jobs:
  publish:
    name: Publish All Modules to Maven Central
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Grant execute permission
        run: chmod +x ./gradlew

      - name: Decode GPG Key
        run: |
          # 1. Base64 디코딩하여 파일 생성 (디버깅/확인용)
          echo "${{ secrets.GPG_SECRET_KEY_BASE64 }}" | base64 --decode > secret.asc

          # 2. [핵심] 디코딩된 키 내용을 'ORG_GRADLE_PROJECT_signingInMemoryKey' 환경변수에 주입
          # 멀티라인 텍스트를 환경변수에 넣기 위한 문법입니다.
          echo "ORG_GRADLE_PROJECT_signingInMemoryKey<<EOF" >> $GITHUB_ENV
          cat secret.asc >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION=$(grep "^projectVersion=" gradle.properties | cut -d'=' -f2)
          else
            TAG=${GITHUB_REF#refs/tags/}
            VERSION=${TAG#v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build all modules
        run: ./gradlew build --no-daemon

      # 배포 순서: core → web, webflux → web-starter, webflux-starter (의존성 순서)
      - name: Publish core
        run: ./gradlew :keycloak-spring-security-core:publish --no-daemon
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.GPG_PASSWORD }}

      - name: Publish web and webflux
        run: |
          ./gradlew :keycloak-spring-security-web:publish --no-daemon
          ./gradlew :keycloak-spring-security-webflux:publish --no-daemon
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.GPG_PASSWORD }}

      - name: Publish web-starter and webflux-starter
        run: |
          ./gradlew :keycloak-spring-security-web-starter:publish --no-daemon
          ./gradlew :keycloak-spring-security-webflux-starter:publish --no-daemon
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.GPG_PASSWORD }}

      - name: Clean up
        if: always()
        run: rm -f secret.asc

  # 배포 완료 알림 (선택사항)
  notify:
    name: Create Release Notes
    runs-on: ubuntu-latest
    needs: publish
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version info
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: "v${{ steps.version.outputs.version }}"
          body: |
            ## Keycloak Spring Security v${{ steps.version.outputs.version }}

            ### Servlet (Spring MVC)
            ```groovy
            implementation 'io.github.l-dxd:keycloak-spring-security-web-starter:${{ steps.version.outputs.version }}'
            ```

            ### Reactive (Spring WebFlux)
            ```groovy
            implementation 'io.github.l-dxd:keycloak-spring-security-webflux-starter:${{ steps.version.outputs.version }}'
            ```

            ### Maven
            ```xml
            <!-- Servlet -->
            <dependency>
                <groupId>io.github.l-dxd</groupId>
                <artifactId>keycloak-spring-security-web-starter</artifactId>
                <version>${{ steps.version.outputs.version }}</version>
            </dependency>

            <!-- Reactive -->
            <dependency>
                <groupId>io.github.l-dxd</groupId>
                <artifactId>keycloak-spring-security-webflux-starter</artifactId>
                <version>${{ steps.version.outputs.version }}</version>
            </dependency>
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
